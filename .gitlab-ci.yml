image: node:latest

stages:
  - test
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - blog/node_modules/
  - ui/node_modules/

# UI part
test-ui:
  stage: test
  tags:
    - docker
    - socket
  script:
    - cd ui/
    - npm ci
    - npm run test
  only:
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

deploy-ui:
  stage: deploy
  tags:
    - docker
    - socket
  script:
    - cd ui/
    - npm ci
    - npm run build
    - cd build/
    - cp index.html 200.html
    - cp index.html 404.html
    - echo "$DOMAIN_UI" > CNAME
    - npx surge .
  only:
    refs:
      - master
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

# Blog part
test-blog:
  stage: test
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm ci
    - npm run format-check
  only:
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"

deploy-blog:
  stage: deploy
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm ci
    - npm run build
    - cd public/
    - cp index.html 200.html
    - echo "$DOMAIN_BLOG" > CNAME
    - npx surge .
  only:
    refs:
      - master
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"
