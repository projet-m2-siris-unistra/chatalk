image: node:lts-alpine

stages:
  - test
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - blog/node_modules/

# UI part
test-ui:
  stage: test
  tags:
    - docker
    - socket
  script:
    - cd ui/
    - npm ci
    - npm run test
  only:
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

deploy-ui:
  stage: deploy
  tags:
    - docker
    - socket
  script:
    - cd ui/
    - npm ci
    - npm run build
    - cd build/
    - cp index.html 200.html
    - cp index.html 404.html
    - echo "$DOMAIN_UI" > CNAME
    - npx surge .
  only:
    refs:
      - master
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

# Blog part
test-blog:
  stage: test
  image: ludovicm67/node-libglu1
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm install
    - npm run format-check
  only:
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"

deploy-blog:
  stage: deploy
  image: ludovicm67/node-libglu1
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm ci
    - npm run build
    - cd public/
    - cp index.html 200.html
    - echo "$DOMAIN_BLOG" > CNAME
    - npx surge .
  only:
    refs:
      - master
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"

.build-service-image: &build-service-image
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - docker
    - socket
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      if [ "$CI_COMMIT_REF_SLUG" == master ]; then
        ARGS="--destination $CI_REGISTRY/$IMAGE"
      fi
      /kaniko/executor $ARGS \
        --destination $CI_REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG \
        --context $CI_PROJECT_DIR/services/$IMAGE \
        --dockerfile $CI_PROJECT_DIR/services/$IMAGE/Dockerfile \
        --build-arg "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        --build-arg "COMMIT=$CI_COMMIT_SHA" \
        --build-arg "VERSION=$CI_COMMIT_REF_SLUG"

build-service-entrypoint:
  <<: *build-service-image
  variables:
    IMAGE: entrypoint

build-service-db-migrations:
  <<: *build-service-image
  variables:
    IMAGE: db-migrations

build-service-fake-ui:
  <<: *build-service-image
  variables:
    IMAGE: fake-ui

build-service-register:
  <<: *build-service-image
  variables:
    IMAGE: register

build-service-ping:
  <<: *build-service-image
  variables:
    IMAGE: ping
