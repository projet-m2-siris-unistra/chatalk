image: node:lts-alpine

stages:
  - test
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - blog/node_modules/

# UI part
test-ui:
  stage: test
  tags:
    - docker
    - socket
  script:
    - cd ui/
    - npm ci
    - npm run test
  only:
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

build-ui:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - docker
    - socket
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      if [ "$CI_COMMIT_REF_SLUG" == master ]; then
        ARGS="--destination $CI_REGISTRY/$IMAGE"
      fi
      /kaniko/executor $ARGS \
        --destination $CI_REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG \
        --context $CI_PROJECT_DIR/$IMAGE \
        --dockerfile $CI_PROJECT_DIR/$IMAGE/Dockerfile \
        --build-arg "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        --build-arg "COMMIT=$CI_COMMIT_SHA" \
        --build-arg "VERSION=$CI_COMMIT_REF_SLUG"
  variables:
    IMAGE: ui
  only:
    changes:
      - ".gitlab-ci.yml"
      - "ui/**/*"

# Blog part
test-blog:
  stage: test
  image: ludovicm67/node-libglu1
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm install
    - npm run format-check
  only:
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"

deploy-blog:
  stage: deploy
  image: ludovicm67/node-libglu1
  tags:
    - docker
    - socket
  script:
    - cd blog/
    - npm ci
    - npm run build
    - cd public/
    - cp index.html 200.html
    - echo "$DOMAIN_BLOG" > CNAME
    - npx surge .
  only:
    refs:
      - master
    changes:
      - ".gitlab-ci.yml"
      - "blog/**/*"

# Services part
.build-service-image: &build-service-image
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - docker
    - socket
  artifacts:
    paths:
      - .build/
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      mkdir -p .build/
      if [ "$CI_COMMIT_REF_SLUG" == master ]; then
        ARGS="--destination $CI_REGISTRY/$IMAGE"
      fi
      /kaniko/executor $ARGS \
        --destination $CI_REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG \
        --context $CI_PROJECT_DIR/services \
        --dockerfile $CI_PROJECT_DIR/services/Dockerfile \
        --build-arg "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        --build-arg "COMMIT=$CI_COMMIT_SHA" \
        --build-arg "VERSION=$CI_COMMIT_REF_SLUG" \
        --build-arg "service=$IMAGE" \
        --digest-file "$CI_PROJECT_DIR/.build/$IMAGE.digest"

build-service-conv_creation:
  <<: *build-service-image
  variables:
    IMAGE: conv_creation
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/conv_creation/**/*"

build-service-conv_manag:
  <<: *build-service-image
  variables:
    IMAGE: conv_manag
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/conv_manag/**/*"

build-service-entrypoint:
  <<: *build-service-image
  variables:
    IMAGE: entrypoint
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/entrypoint/**/*"

build-service-login:
  <<: *build-service-image
  variables:
    IMAGE: login
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/login/**/*"

build-service-msg_sender:
  <<: *build-service-image
  variables:
    IMAGE: msg_sender
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/msg_sender/**/*"

build-service-ping:
  <<: *build-service-image
  variables:
    IMAGE: ping
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/ping/**/*"

build-service-register:
  <<: *build-service-image
  variables:
    IMAGE: register
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/register/**/*"

build-service-send-info:
  <<: *build-service-image
  variables:
    IMAGE: send-info
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/send-info/**/*"

deploy-service-entrypoint:
  stage: deploy
  tags:
    - docker
    - socket
  image: alpine:latest
  script:
    - ls -al .
    - ls -al .build/
    - cat .build/*
  variables:
    IMAGE: entrypoint
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/entrypoint/**/*"

# database migrations
build-db-migrations:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  tags:
    - docker
    - socket
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      if [ "$CI_COMMIT_REF_SLUG" == master ]; then
        ARGS="--destination $CI_REGISTRY/$IMAGE"
      fi
      /kaniko/executor $ARGS \
        --destination $CI_REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG \
        --context $CI_PROJECT_DIR/$IMAGE \
        --dockerfile $CI_PROJECT_DIR/$IMAGE/Dockerfile \
        --build-arg "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        --build-arg "COMMIT=$CI_COMMIT_SHA" \
        --build-arg "VERSION=$CI_COMMIT_REF_SLUG"
  variables:
    IMAGE: db-migrations
  only:
    changes:
      - ".gitlab-ci.yml"
      - "services/db-migrations/**/*"
